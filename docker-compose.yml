services:
  app:
    build:
      context: .
      secrets:
        - github_token
      ssh:
        - default
    image: mini-chat:latest
    ports:
      - "8000:8000"
      - "5173:5173"
    volumes:
      # Mount backend for development hot-reload
      - ./backend:/app
      # Mount frontend for development hot-reload
      - ./frontend:/frontend
      # Mount database to persist data
      - ./data:/data
      # Allow us to map in /tmp
      - "${BITBUCKET_CLONE_DIR:-/tmp}:/tmp"
    environment:
      - PYTHONUNBUFFERED=1
    entrypoint: ""
    command:
      - sh
      - -c
      - |
        npm run dev -- --host &
        cd /app && python -m uvicorn mini_chat.main:app --host 0.0.0.0 --port 8000 --reload

secrets:
  github_token:
    environment: GITHUB_TOKEN
